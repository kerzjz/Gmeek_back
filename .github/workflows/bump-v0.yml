name: Bump & Auto Release

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write   # 需要写仓库（提交、打 tag、建 release）

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      # 1. 拉代码（一定要带全部 tag）
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. 配置 git 身份
      - name: git config
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # 3. 计算下一个 v0.x 版本（+0.1，保留前导零）
      - name: calc next tag
        id: ver
        run: |
          LATEST=$(git tag -l 'v0.*' --sort=-v:refname | head -n 1)
          [ -z "$LATEST" ] && LATEST="v0.3"          # 仓库为空时的默认值
          NUM=${LATEST#v}                            # 去掉 v 前缀，如 0.3
          # 用 bc + printf 保留前导零，避免 .4 这类畸形
          NEXT=$(printf "%.1f" "$(echo "$NUM + 0.1" | bc)")
          NEXT_TAG="v${NEXT}"
          echo "next_tag=$NEXT_TAG" >> $GITHUB_OUTPUT
          echo "Latest tag $LATEST  →  next $NEXT_TAG"

      # 4. 把新版本号写进文件（示例：version.txt）
      - name: bump file
        run: |
          echo "${{ steps.ver.outputs.next_tag }}" > version.txt
          git add version.txt
          git diff --staged --quiet && exit 0        # 没变化直接结束
          git commit -m "chore: bump version to ${{ steps.ver.outputs.next_tag }}"
          git push

      # 5. 打 tag（如已存在则强制更新，避免 128 错误）
      - name: create tag
        run: |
          git tag -f "${{ steps.ver.outputs.next_tag }}"
          git push -f origin "${{ steps.ver.outputs.next_tag }}"

      # 6. 构建产物（按自己项目改）
      - name: build
        run: |
          # 示例：Python 项目打包
          python -m pip install --upgrade build
          python -m build

      # 7. 自动生成 Release 并上传附件
      - name: release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ver.outputs.next_tag }}
          name:     ${{ steps.ver.outputs.next_tag }}
          body:     "自动发布 ${{ steps.ver.outputs.next_tag }}"
          files:    dist/*
          draft:    false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
